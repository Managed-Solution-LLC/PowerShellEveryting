# TLS and DHE Cipher Suite Remediation Script
# Purpose: Disable TLS 1.0/1.1 and DHE cipher suites to remediate CVE-2002-20001, CVE-2022-40735
# Run as Administrator

# Check if running as Administrator
if (-NOT ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole] "Administrator")) {
    Write-Host "This script must be run as Administrator. Exiting..." -ForegroundColor Red
    exit 1
}

Write-Host "========================================" -ForegroundColor Cyan
Write-Host "TLS and DHE Remediation Script" -ForegroundColor Cyan
Write-Host "========================================" -ForegroundColor Cyan
Write-Host ""

# Function to create registry key if it doesn't exist
function Ensure-RegistryPath {
    param([string]$Path)
    if (!(Test-Path $Path)) {
        New-Item -Path $Path -Force | Out-Null
        Write-Host "Created registry path: $Path" -ForegroundColor Green
    }
}

# Backup current settings
$backupFile = "TLS_Settings_Backup_$(Get-Date -Format 'yyyyMMdd_HHmmss').reg"
$regExport = Start-Process -FilePath "reg" -ArgumentList "export", '"HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL"', $backupFile, "/y" -Wait -PassThru -NoNewWindow
if ($regExport.ExitCode -ne 0) {
    Write-Host "Warning: Backup failed. Continue? (Y/N)" -ForegroundColor Red
    $continue = Read-Host
    if ($continue -ne "Y" -and $continue -ne "y") { exit 1 }
}
reg export "HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL" $backupFile /y | Out-Null

# ============================================
# PART 1: Disable TLS 1.0 and 1.1
# ============================================
Write-Host ""
Write-Host "Part 1: Disabling TLS 1.0 and 1.1..." -ForegroundColor Yellow

$protocols = @("TLS 1.0", "TLS 1.1")
$sides = @("Client", "Server")

foreach ($protocol in $protocols) {
    foreach ($side in $sides) {
        $regPath = "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\$protocol\$side"
        
        Ensure-RegistryPath -Path $regPath
        
        # Disable the protocol
        Set-ItemProperty -Path $regPath -Name "Enabled" -Value 0 -Type DWord
        Set-ItemProperty -Path $regPath -Name "DisabledByDefault" -Value 1 -Type DWord
        
        Write-Host "  Disabled $protocol for $side" -ForegroundColor Green
    }
}

# ============================================
# PART 2: Enable TLS 1.2 and 1.3
# ============================================
Write-Host ""
Write-Host "Part 2: Enabling TLS 1.2 and 1.3..." -ForegroundColor Yellow

$enableProtocols = @("TLS 1.2", "TLS 1.3")

foreach ($protocol in $enableProtocols) {
    foreach ($side in $sides) {
        $regPath = "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\$protocol\$side"
        
        Ensure-RegistryPath -Path $regPath
        
        # Enable the protocol
        Set-ItemProperty -Path $regPath -Name "Enabled" -Value 1 -Type DWord
        Set-ItemProperty -Path $regPath -Name "DisabledByDefault" -Value 0 -Type DWord
        
        Write-Host "  Enabled $protocol for $side" -ForegroundColor Green
    }
}

# ============================================
# PART 3: Disable DHE Cipher Suites
# ============================================
Write-Host ""
Write-Host "Part 3: Disabling DHE cipher suites..." -ForegroundColor Yellow

# List of DHE cipher suites to disable (common ones)
$dheCiphers = @(
    "TLS_DHE_RSA_WITH_AES_256_GCM_SHA384",
    "TLS_DHE_RSA_WITH_AES_128_GCM_SHA256",
    "TLS_DHE_RSA_WITH_AES_256_CBC_SHA256",
    "TLS_DHE_RSA_WITH_AES_128_CBC_SHA256",
    "TLS_DHE_RSA_WITH_AES_256_CBC_SHA",
    "TLS_DHE_RSA_WITH_AES_128_CBC_SHA",
    "TLS_DHE_RSA_WITH_3DES_EDE_CBC_SHA",
    "TLS_DHE_DSS_WITH_AES_256_GCM_SHA384",
    "TLS_DHE_DSS_WITH_AES_128_GCM_SHA256",
    "TLS_DHE_DSS_WITH_AES_256_CBC_SHA256",
    "TLS_DHE_DSS_WITH_AES_128_CBC_SHA256",
    "TLS_DHE_DSS_WITH_AES_256_CBC_SHA",
    "TLS_DHE_DSS_WITH_AES_128_CBC_SHA",
    "TLS_DHE_DSS_WITH_3DES_EDE_CBC_SHA"
)

$cipherPath = "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Ciphers"
Ensure-RegistryPath -Path $cipherPath

foreach ($cipher in $dheCiphers) {
    $cipherKeyPath = "$cipherPath\$cipher"
    Ensure-RegistryPath -Path $cipherKeyPath
    
    # Disable the cipher
    Set-ItemProperty -Path $cipherKeyPath -Name "Enabled" -Value 0 -Type DWord
    Write-Host "  Disabled cipher: $cipher" -ForegroundColor Green
}

# ============================================
# PART 4: Configure cipher suite order (optional but recommended)
# ============================================
Write-Host ""
Write-Host "Part 4: Setting preferred cipher suite order..." -ForegroundColor Yellow

# This prioritizes ECDHE and RSA ciphers over DHE
$preferredCiphers = @(
    "TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384",
    "TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256",
    "TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384",
    "TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256",
    "TLS_RSA_WITH_AES_256_GCM_SHA384",
    "TLS_RSA_WITH_AES_128_GCM_SHA256",
    "TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384",
    "TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256",
    "TLS_RSA_WITH_AES_256_CBC_SHA256",
    "TLS_RSA_WITH_AES_128_CBC_SHA256"
)

$cipherOrder = $preferredCiphers -join ","

try {
    # For Windows Server 2016/Windows 10 and later
    $policyPath = "HKLM:\SOFTWARE\Policies\Microsoft\Cryptography\Configuration\SSL\00010002"
    Ensure-RegistryPath -Path $policyPath
    Set-ItemProperty -Path $policyPath -Name "Functions" -Value $cipherOrder -Type String
    Write-Host "  Set cipher suite order successfully" -ForegroundColor Green
} catch {
    Write-Host "  Could not set cipher suite order (may not be supported on this OS version) $($_.Exception.Message)" -ForegroundColor Yellow
}

# ============================================
# PART 5: Additional IIS Settings (if IIS is installed)
# ============================================
Write-Host ""
Write-Host "Part 5: Checking for IIS..." -ForegroundColor Yellow

if (Get-Service -Name W3SVC -ErrorAction SilentlyContinue) {
    Write-Host "  IIS detected. Applying IIS-specific settings..." -ForegroundColor Green
    
    # Import IIS module if available
    if (Get-Module -ListAvailable -Name IISAdministration) {
        Import-Module IISAdministration
        
        # Update IIS SSL bindings to use TLS 1.2+
        $iisPath = "HKLM:\SOFTWARE\Microsoft\IISSecurity"
        if (!(Test-Path $iisPath)) {
            New-Item -Path $iisPath -Force | Out-Null
        }
        Set-ItemProperty -Path $iisPath -Name "SystemDefaultTlsVersions" -Value 1 -Type DWord
        Write-Host "  Configured IIS to use system default TLS versions" -ForegroundColor Green
    }
} else {
    Write-Host "  IIS not detected, skipping IIS-specific settings" -ForegroundColor Gray
}

# ============================================
# PART 6: RDP Settings for port 3389
# ============================================
Write-Host ""
Write-Host "Part 6: Securing RDP (port 3389)..." -ForegroundColor Yellow

$rdpPath = "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp"
if (Test-Path $rdpPath) {
    # Force RDP to use TLS 1.2
    Set-ItemProperty -Path $rdpPath -Name "SecurityLayer" -Value 2 -Type DWord
    Set-ItemProperty -Path $rdpPath -Name "MinEncryptionLevel" -Value 3 -Type DWord
    Write-Host "  Configured RDP to use enhanced security" -ForegroundColor Green
}

# ============================================
# Summary and Restart Prompt
# ============================================
Write-Host ""
Write-Host "========================================" -ForegroundColor Cyan
Write-Host "Remediation Complete!" -ForegroundColor Green
Write-Host "========================================" -ForegroundColor Cyan
Write-Host ""
Write-Host "Changes made:" -ForegroundColor Yellow
Write-Host "  - Disabled TLS 1.0 and TLS 1.1" -ForegroundColor White
Write-Host "  - Enabled TLS 1.2 and TLS 1.3" -ForegroundColor White
Write-Host "  - Disabled DHE cipher suites" -ForegroundColor White
Write-Host "  - Set preferred cipher suite order" -ForegroundColor White
Write-Host "  - Backup saved to: $backupFile" -ForegroundColor White
Write-Host ""
Write-Host "IMPORTANT: A system restart is required for these changes to take effect!" -ForegroundColor Red
Write-Host ""

$restart = Read-Host "Do you want to restart the computer now? (Y/N)"
if ($restart -eq "Y" -or $restart -eq "y") {
    Write-Host "Restarting in 10 seconds..." -ForegroundColor Yellow
    Start-Sleep -Seconds 10
    Restart-Computer -Force
} else {
    Write-Host "Please remember to restart the system manually for changes to take effect." -ForegroundColor Yellow
}